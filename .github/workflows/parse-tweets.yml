name: Parse Tweets Hourly

on:
  schedule:
    # Run every hour at minute 15 (15 min after fetch)
    - cron: '15 * * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  PARSE_BATCH_LIMIT: 25

jobs:
  parse-tweets:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Run parser until queue empty
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PARSE_BATCH_LIMIT: 25
        run: |
          MAX_ITERATIONS=10
          ITERATION=0
          
          while [ $ITERATION -lt $MAX_ITERATIONS ]; do
            echo "Parser iteration $((ITERATION + 1))/$MAX_ITERATIONS"
            
            # Run parser (will process up to PARSE_BATCH_LIMIT tweets)
            node scripts/parse_tweets_with_three_layer.js
            
            # Check if there are still pending tweets
            PENDING_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM raw_tweets WHERE processing_status='pending';" | tr -d ' ')
            
            if [ "$PENDING_COUNT" -eq 0 ]; then
              echo "✅ All pending tweets processed"
              break
            fi
            
            echo "⏳ Still $PENDING_COUNT pending tweets, continuing..."
            ITERATION=$((ITERATION + 1))
            
            # Small delay between iterations
            sleep 5
          done
          
          if [ $ITERATION -eq $MAX_ITERATIONS ]; then
            echo "⚠️ Reached max iterations, some tweets may still be pending"
          fi
      
      - name: Log parse metrics
        if: always()
        run: |
          echo "Parse job completed at $(date -u +%Y-%m-%dT%H:%M:%SZ)"

