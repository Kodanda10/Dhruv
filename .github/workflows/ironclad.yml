name: Ironclad Production CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

permissions:
  contents: read
  security-events: write
  actions: read
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Database and infrastructure validation
  infra-validate:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup PostgreSQL
        run: |
          PGPASSWORD=test_password psql -h localhost -U postgres -c "CREATE DATABASE test_db;"

      - name: Validate migrations
        run: |
          find infra/migrations -name "*.sql" -exec echo "Validating {}" \;
          find infra/migrations -name "*.sql" -exec psql -h localhost -U postgres -d test_db -f {} \; || exit 1

      - name: Test Docker Compose config
        run: docker-compose config --quiet

  # Frontend linting and type checking
  lint-type:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run typecheck

  # Unit tests with coverage
  unit-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:test_password@localhost:5432/test_db
      REDIS_URL: redis://localhost:6379
      NODE_ENV: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      - run: npm ci

      # Setup test database
      - name: Setup test database
        run: npm run db:test:setup

      - name: Run unit tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: Enforce coverage requirements (85% lines, 70% branches)
        run: |
          npx nyc check-coverage \
            --lines 85 \
            --branches 70 \
            --functions 80 \
            --statements 85

  # API tests
  api-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:test_password@localhost:5432/test_db
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements.txt pytest pytest-cov
      - name: Setup test database
        run: |
          PGPASSWORD=test_password psql -h localhost -U postgres -d test_db -f infra/migrations/001_create_raw_tweets_table.sql
          PGPASSWORD=test_password psql -h localhost -U postgres -d test_db -f infra/migrations/002_create_parsed_events_table.sql
      - name: Run API tests
        env:
          PYTHONPATH: .
        run: pytest api/tests/ -v --cov=api --cov-report=xml
      - name: Upload API coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: apitests
          name: codecov-umbrella

  # Security scanning
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      - run: npm ci

      # Secret scanning
      - name: Secret scan
        uses: trufflesecurity/trufflehog@main

      # Dependency vulnerability scan
      - name: Run npm audit
        run: npm audit --audit-level moderate

      # SAST with CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,python
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # Build and container security
  build-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker images
        run: |
          docker build -t app-test -f Dockerfile .
          docker build -t websocket-test -f Dockerfile.websocket .

      - name: Scan Docker images
        uses: anchore/scan-action@v3
        with:
          image: app-test
          fail-build: true
          severity-cutoff: medium

      - name: Container structure test
        uses: GoogleContainerTools/container-structure-test@v1
        with:
          image: app-test
          configFile: .container-structure-test.yml

  # E2E and integration tests
  e2e-integration:
    runs-on: ubuntu-latest
    needs: [lint-type, unit-tests, api-tests]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:test_password@localhost:5432/test_db
      REDIS_URL: redis://localhost:6379
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      - run: npm ci
      - run: npm run build

      # Setup test data
      - name: Setup integration test data
        run: npm run db:test:seed

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: npm run e2e:ci

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: test-results/

  # Performance and accessibility
  perf-a11y:
    runs-on: ubuntu-latest
    needs: [lint-type]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:test_password@localhost:5432/test_db
      REDIS_URL: redis://localhost:6379
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      - run: npm ci
      - run: npm run build

      # Start application
      - name: Start application
        run: npm run start &
      - name: Wait for app to be ready
        run: npx wait-on http://localhost:3000/api/health

      # Performance testing
      - name: Run k6 performance tests
        uses: grafana/k6-action@v0.3.1
        with:
          filename: perf/k6_health_check.js

      - name: Lighthouse performance audit
        run: npx lhci autorun

      - name: Accessibility testing
        run: npm run test:a11y

  # License and SBOM
  compliance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      - run: npm ci

      - name: Generate SBOM
        run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json

      - name: License compliance check
        run: npx license-checker --summary --production --failOn BSD

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

  # Production deployment preparation
  deploy-prep:
    runs-on: ubuntu-latest
    needs: [infra-validate, lint-type, unit-tests, api-tests, security, build-security, e2e-integration, perf-a11y, compliance]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Generate deployment metadata
        id: meta
        run: |
          echo "tags=ghcr.io/${{ github.repository }}:latest,ghcr.io/${{ github.repository }}:sha-${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "deploy=true" >> $GITHUB_OUTPUT

      - name: Create deployment artifact
        run: |
          echo "Deployment approved for production" > deploy-artifact.txt
          echo "Commit: ${{ github.sha }}" >> deploy-artifact.txt
          echo "Timestamp: $(date)" >> deploy-artifact.txt

      - uses: actions/upload-artifact@v4
        with:
          name: deployment-approval
          path: deploy-artifact.txt

  # Production deployment
  deploy:
    runs-on: ubuntu-latest
    needs: [deploy-prep]
    if: needs.deploy-prep.outputs.deploy == 'true'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker images
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ needs.deploy-prep.outputs.image-tag }}
          labels: |
            org.opencontainers.image.title=Chhattisgarh Analytics Dashboard
            org.opencontainers.image.description=Social media analytics platform for Chhattisgarh
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.version=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Deploy to production
        run: |
          echo "üöÄ Deployment to production initiated"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          # Add actual deployment commands here (e.g., kubectl, docker-compose, etc.)

      - name: Health check post-deployment
        run: |
          echo "‚è≥ Waiting for deployment to stabilize..."
          sleep 30
          # Add health check commands here

  # Audit trail generation
  audit-trail:
    runs-on: ubuntu-latest
    if: always()
    needs: [infra-validate, lint-type, unit-tests, api-tests, security, build-security, e2e-integration, perf-a11y, compliance]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      - run: npm ci
      - name: Generate comprehensive audit trail
        run: npm run audit:generate
      - uses: actions/upload-artifact@v4
        with:
          name: audit-trail
          path: audit-trail.json
