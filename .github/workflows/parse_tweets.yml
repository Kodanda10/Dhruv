name: Parse Tweets (3-Layer Consensus)

on:
  workflow_dispatch:
    inputs:
      start_offset:
        description: "Start index (default 0)"
        required: false
        default: "0"
      batch_size:
        description: "Batch size (default 250)"
        required: false
        default: "250"
      dry_run:
        description: "Dry run (true/false)"
        required: false
        default: "false"

concurrency:
  group: parse-tweets
  cancel-in-progress: false

env:
  NODE_ENV: production
  API_BASE: ${{ secrets.API_BASE }}
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  OLLAMA_HOST: ${{ secrets.OLLAMA_HOST }}
  PARSER_VERSION: v3-consensus-001
  EVENT_HIGH: "0.88"
  EVENT_LOW: "0.60"

jobs:
  parse:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: |
          corepack enable
          pnpm i --frozen-lockfile

      - name: Restore checkpoint
        id: ckpt
        uses: actions/cache@v4
        with:
          path: .workflow/checkpoints
          key: ckpt-${{ github.run_id }}
          restore-keys: ckpt-

      - name: Run parser (3-layer consensus)
        run: |
          node scripts/parse_tweets.js \
            --start ${{ github.event.inputs.start_offset || 0 }} \
            --batch ${{ github.event.inputs.batch_size || 250 }} \
            --dry ${{ github.event.inputs.dry_run || 'false' }}

      - name: Save checkpoint
        uses: actions/cache@v4
        with:
          path: .workflow/checkpoints
          key: ckpt-${{ github.run_id }}

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: parse-reports
          path: .workflow/reports/**

  verify:
    needs: parse
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: |
          corepack enable
          pnpm i --frozen-lockfile

      - name: Run Playwright verification
        run: |
          npx playwright test tests/verification/parse-verification.spec.ts --headed=false

      - name: Upload verification screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: verification-screenshots
          path: test-results/**