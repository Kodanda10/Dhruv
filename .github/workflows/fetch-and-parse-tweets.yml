name: Fetch and Parse New Tweets

on:
  schedule:
    # Run every 2 hours (cron syntax: minute hour day month day-of-week)
    # Runs at :00 and :00 of every 2nd hour (00:00, 02:00, 04:00, ...)
    - cron: '0 */2 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      max_tweets:
        description: 'Maximum tweets to fetch (default: 100)'
        required: false
        default: '100'
        type: string
      parse_delay:
        description: 'Delay between parsing tweets in seconds (default: 6.0)'
        required: false
        default: '6.0'
        type: string

jobs:
  fetch-and-parse:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hour timeout (enough for 100 tweets with 6s delay)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f api/requirements.txt ]; then
            pip install -r api/requirements.txt
          fi
          pip install psycopg2-binary tweepy python-dotenv requests
      
      - name: Configure PostgreSQL connection
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV
          echo "X_BEARER_TOKEN=${{ secrets.X_BEARER_TOKEN }}" >> $GITHUB_ENV
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_ENV
          echo "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" >> $GITHUB_ENV
      
      - name: Create logs directory
        run: mkdir -p logs
      
      - name: Fetch and parse new tweets
        id: fetch-parse
        run: |
          set -e
          
          MAX_TWEETS="${{ inputs.max_tweets || '100' }}"
          PARSE_DELAY="${{ inputs.parse_delay || '6.0' }}"
          
          echo "ðŸš€ Starting tweet fetch and parse job"
          echo "   Max tweets: $MAX_TWEETS"
          echo "   Parse delay: $PARSE_DELAYs (Gemini rate limit protection)"
          echo ""
          
          # Fetch new tweets
          python3 scripts/fetch_new_tweets_incremental.py \
            --max-tweets $MAX_TWEETS \
            --parse \
            --parse-delay $PARSE_DELAY \
            --handle OPChoudhary_Ind \
            2>&1 | tee logs/fetch_parse_$(date +%Y%m%d_%H%M%S).log
          
          EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… SUCCESS: Tweet fetch and parse completed"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ERROR: Tweet fetch and parse failed (exit code: $EXIT_CODE)"
            echo "success=false" >> $GITHUB_OUTPUT
            exit $EXIT_CODE
          fi
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fetch-parse-logs-${{ github.run_id }}
          path: logs/
          retention-days: 7
      
      - name: Get parsing status
        if: success()
        run: |
          echo "ðŸ“Š Final Status Report"
          echo "======================"
          python3 scripts/get_complete_status.py 2>&1 | head -50
      
      - name: Create status summary
        if: always()
        run: |
          echo "## ðŸ“Š Tweet Fetch & Parse Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.fetch-parse.outputs.success }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f logs/fetch_parse_*.log ]; then
            echo "### ðŸ“ Recent Log Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -30 logs/fetch_parse_*.log | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

