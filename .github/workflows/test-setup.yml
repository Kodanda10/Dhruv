name: Test Bulk Ingestion Setup

on:
  workflow_dispatch:

jobs:
  test-setup:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test Environment
      run: |
        echo "✅ Workflow is running!"
        echo "Branch: $GITHUB_REF_NAME"
        echo "Repository: $GITHUB_REPOSITORY"
        echo "Environment: production"
        echo "Available secrets:"
        echo "- DATABASE_URL: ${{ secrets.DATABASE_URL != '' && '✅ Set' || '❌ Missing' }}"
        echo "- GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY != '' && '✅ Set' || '❌ Missing' }}"
        echo "- X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN != '' && '✅ Set' || '❌ Missing' }}"

    - name: Test Node.js Setup
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Test Build
      run: npm run build

    - name: Test Health Check
      run: |
        npm run start &
        SERVER_PID=$!
        sleep 5

        echo "Testing health endpoint..."
        if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
          echo "✅ Server health check passed!"
        else
          echo "❌ Server health check failed"
          exit 1
        fi

        kill $SERVER_PID 2>/dev/null || true